rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // List of admin emails - add your admin email(s) here
    function isAdminEmail(email) {
      return email in [
        'admin@conferenceapp.com',
        'admin@example.com'
        // Add more admin emails as needed
      ];
    }

    function isAdmin() {
      // Check for custom claim OR admin email list
      return request.auth != null && (
        request.auth.token.role == 'admin' ||
        isAdminEmail(request.auth.token.email)
      );
    }

    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /submissions/{submissionId} {
      // Anyone signed in can create submissions
      allow create: if isSignedIn();
      
      // Allow all authenticated users to read submissions (for admin panel access)
      allow read: if isSignedIn();
      
      // Users can update their own submissions:
      //   1. Normal updates (except status/review fields)
      //   2. Revision resubmission: ONLY when transitioning from
      //      accepted_with_revision → pending_review (clears review fields)
      // Admins can update any submission (including status/review)
      allow update: if isSignedIn() && (
        // Case 1: Owner updating non-review fields
        (resource.data.uid == request.auth.uid && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'reviewedBy', 'reviewedAt', 'reviewComments'])) ||
        // Case 2: Owner resubmitting revision (accepted_with_revision → pending_review)
        (resource.data.uid == request.auth.uid &&
         resource.data.status == 'accepted_with_revision' &&
         request.resource.data.status == 'pending_review') ||
        // Case 3: Admin can update anything
        isAdmin()
      );
      
      // Only admins can delete submissions
      allow delete: if isAdmin();
    }

    match /app_settings/{doc} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /counters/{doc} {
      allow read, write: if isSignedIn();
    }
  }
}
